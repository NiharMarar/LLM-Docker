services:
  webui:
    image: ghcr.io/ai-dock/stable-diffusion-webui:latest-cpu
    container_name: stable-diffusion
    ports:
      - "7860:17860"
    volumes:
      - ./models:/data/models
      - ./outputs:/data/outputs
      - ./workspace:/data/workspace
      - /usr/lib/wsl:/usr/lib/wsl:ro       # <-- add this (gives libd3d12.so, libdxcore.so)
    devices:
      - /dev/dri:/dev/dri
      - /dev/dxg:/dev/dxg
    environment:
      - SUPERVISOR_NO_AUTOSTART=caddy,cloudflared,serviceportal,jupyter,syncthing
      - WEBUI_ARGS=--listen --port 17860 --lowvram --medvram --no-half --max-batch-count 1 --ckpt-dir /data/models/Stable-diffusion
      - TZ=America/Los_Angeles
      - CF_QUICK_TUNNEL=false
      - LD_LIBRARY_PATH=/usr/lib/wsl/lib:$LD_LIBRARY_PATH   # <-- add this
    restart: unless-stopped
